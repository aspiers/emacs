@SET_MAKE@

# location of required programms
TAR = @TAR@
RM   = @RM@
XARGS = @XARGS@
TLA = @TLA@
prefix = @prefix@

SUBDIRS = lisp texinfo

EMACS_PROG = @EMACS_PROG@
EMACS_FLAVOR = @EMACS_FLAVOR@
EMACS_VERSION = @EMACS_VERSION@
INSTALL = @INSTALL@

##############################################################################
all: xtla info xtla-load.el xtla-load-install.el

Makefile: config.status @srcdir@/Makefile.in
	./config.status $@

xtla-load.el: config.status @srcdir@/xtla-load.el.in
	./config.status $@

xtla-load-install.el: config.status @srcdir@/xtla-load-install.el.in
	./config.status $@

@srcdir@/configure: @srcdir@/configure.ac
	cd @srcdir@ ; autoconf
	./config.status --recheck

config.status: @srcdir@/configure
	./config.status --recheck

info:
	$(MAKE) -C texinfo info
pdf:
	$(MAKE) -C texinfo pdf
dvi:
	$(MAKE) -C texinfo pdf
html:
	$(MAKE) -C texinfo pdf

xtla:
	cd lisp; $(MAKE)

install: install-pkg

uninstall: uninstall-pkg

install-deb:
	$(MAKE) -C texinfo install
	$(MAKE) -C lisp install-el
	$(MAKE) -C lisp install-ewoc

install-pkg:
	@for i in $(SUBDIRS) ; do             \
          ( cd $$i && $(MAKE) install-pkg ) ; \
        done
	sed 's|$$(prefix)|$(prefix)|' xtla-load-install.el \
            > @lispdir@/xtla-load.el

uninstall-pkg:
	@for i in $(SUBDIRS) ; do               \
          ( cd $$i && $(MAKE) uninstall-pkg ) ; \
        done
	-$(RM) -f @lispdir@/xtla-load.el

clean:
	@for i in $(SUBDIRS) ; do               \
          ( cd $$i && $(MAKE) clean ) ; \
        done
	-$(RM) -f xtla-load.el xtla-load-install.el

distclean:
#	$(TLA) inventory -B -j | $(XARGS) $(RM)
#	$(TLA) inventory -B -p | $(XARGS) $(RM)

##############################################################################
TARFILES = configure $(shell cd @abs_top_srcdir@ && $(TLA) inventory -s)

lisp/xtla-version.el:
	cd lisp; make xtla-version.el

# Note: for "normal" installations, the file will be called
# xtla-autoloads.el. XEmacs package are considered as a special case.
lisp/xtla-autoloads.el:
	cd lisp; make xtla-autoloads.el

texinfo/xtla-version.texinfo:
	cd texinfo; make xtla-version.texinfo

generated-files: lisp/xtla-version.el \
		 lisp/xtla-autoloads.el \
		 texinfo/xtla-version.texinfo

ifeq ($(RELEASE_ID),)
TARDIRNAME=xtla-snapshot
else
TARDIRNAME=xtla-$(RELEASE_ID)
endif

dist: tarball

tarball: $(TARFILES:%=@abs_top_srcdir@/%)
# 	cd @abs_top_srcdir@ && $(TLA) changes || \
# 	(echo ERROR: There are changes in the tree, please commit before creating a tarball\!;\
# 	 echo ERROR: since otherwise lisp/xtla-version.el is not correct\!; exit 1)
	$(RM) -f lisp/xtla-version.el texinfo/xtla-version.texinfo
	cd lisp; make xtla-version.el
	cd texinfo; make xtla-version.texinfo
	-$(RM) -rf ./,,tarball
	mkdir -p ./,,tarball/$(TARDIRNAME)
	(cd @abs_top_srcdir@ && $(TLA) changelog) >>  ,,tarball/$(TARDIRNAME)/ChangeLog
	(cd @abs_top_srcdir@ && $(TAR) cf - $(TARFILES)) \
		| (cd ,,tarball/$(TARDIRNAME) ; $(TAR) xf -)
	$(TAR) cf - lisp/xtla-version.el texinfo/xtla-version.texinfo \
		| (cd ,,tarball/$(TARDIRNAME) ; $(TAR) xf -)
	cd ./,,tarball; $(TAR) -cvzf ../$(TARDIRNAME).tar.gz $(TARDIRNAME)
	@echo "*** $(TARDIRNAME).tar.gz created ***"

##############################################################################
# for the creation of an XEmacs package
PKGDIR =  $(shell pwd)/,,package/
PKGINFO = $(PKGDIR)/lisp/xtla/_pkg.el
xemacs-package:
# 	cd @abs_top_srcdir@ && $(TLA) changes || \
# 	(echo ERROR: There are changes in the tree, please commit before creating a tarball\!;\
# 	 echo ERROR: since otherwise lisp/xtla-version.el is not correct\!; exit 1)
	if [ "x@EMACS_FLAVOR@" != "xxemacs" ]; then \
		echo "ERROR: Current build dir not configured for XEmacs,"; \
		echo "ERROR: Please re-run configure with --with-emacs=xemacs."; \
		exit 1; \
	fi
	-$(RM) -rf ,,package
	cd lisp; make PACKAGEDIR=$(PKGDIR)/lisp/xtla install-pkg
	cd texinfo; make info_dir=$(PKGDIR)/info install-pkg
	(cd @srcdir@; $(TLA) changelog) > $(PKGDIR)/lisp/ChangeLog
	echo ";;;###autoload" > $(PKGINFO)
	echo "(package-provide 'xtla'" > $(PKGINFO)
	echo "         :version 0.7" >> $(PKGINFO)
	echo '         :author-version "'`$(TLA) logs -fr -d "@top_srcdir@" | head -1`'"' >> $(PKGINFO)
	echo "         :type 'regular)" >> $(PKGINFO)
	mkdir $(PKGDIR)/pkginfo;
	touch $(PKGDIR)/pkginfo/MANIFEST.xtla;
	cd $(PKGDIR); find -type f | cut -c3- > pkginfo/MANIFEST.xtla
	cd ,,package; $(TAR) -cvzf ../xtla-pkg.tar.gz *
