# Adam's emacs Makefile

# {{{ Determine emacs version

ifndef EMACS
  EMACS=emacs
endif

version=$(shell $(EMACS) --version)

VERSION_NUMBER=$(shell echo "$(version)" | \
                   perl -ne '/^\s*(GNU |X)Emacs (\d+\.\d+)/ && print "$$2"')

# }}}

# {{{ Un-tweakable parameters

MAJOR_MODES = major-modes
MINOR_MODES = minor-modes
UTILS	    = utils

# }}}
# {{{ Tweakable parameters

# {{{ 3rd party packages

# 3rd party packages are those which have their own Makefiles
# and are responsible for compiling *and* installing themselves.

# These should be symlinked to the correct versions.
ORG_DIR        = $(MAJOR_MODES)/org-mode.git
EPG_DIR        = $(MAJOR_MODES)/epg
REMEMBER_DIR   = $(MAJOR_MODES)/remember
YASNIPPET_DIR = $(MINOR_MODES)/yasnippet
ifeq (,$(wildcard $(YASNIPPET_DIR)))
	YASNIPPET_DIR=
endif
COLOR_THEME_DIR = color-theme

# Pros of symlinking foo -> foo-1.2.3 approach:
#  - allows different versions per machine
#
# Cons:
#  - need to set up manually?

# This is a list of make targets which have their own Makefiles
# and are responsible for compiling *and* installing themselves.
THIRD_PARTY_PKG_TARGETS = 		\
	.psgml-made

# Don't automatically compile *.el in or install *.elc from these
# directories:
THIRD_PARTY_PKG_DIRS =          \
	$(MAJOR_MODES)/psgml

ifneq (,$(wildcard $(ORG_DIR)))
	THIRD_PARTY_PKG_TARGETS += .org-installed
	THIRD_PARTY_PKG_DIRS    += $(ORG_DIR)
endif
ifneq (,$(wildcard $(REMEMBER_DIR)))
	THIRD_PARTY_PKG_TARGETS += .remember-installed
	THIRD_PARTY_PKG_DIRS    += $(REMEMBER_DIR)
endif
ifneq (,$(wildcard $(COLOR_THEME_DIR)))
	THIRD_PARTY_PKG_TARGETS += .color-theme-installed
	THIRD_PARTY_PKG_DIRS    += $(COLOR_THEME_DIR)
endif

# }}}
# {{{ Where do we pick up .el files which don't have their own Makefiles?

CUCUMBER_DIR = $(MAJOR_MODES)/cucumber
ifeq (,$(wildcard $(CUCUMBER_DIR)))
	CUCUMBER_DIR=
endif

el_search_paths = 			\
	init/common 			\
	$(wildcard $(MAJOR_MODES)/*.el) \
	$(MAJOR_MODES)/mmm 		\
	$(MAJOR_MODES)/pcl-cvs 		\
	$(MAJOR_MODES)/pgg 		\
	$(ORG_DIR)/contrib/lisp		\
	$(CUCUMBER_DIR) 		\
	$(MINOR_MODES) 			\
	$(UTILS) 			\
	fun

# }}}

# {{{ Which .el files should override ones from the emacs distribution?

# N.B. The override is performed by moving these .el files from
# $(POST_INSTALL_DIR) to $(PRE_INSTALL_DIR).

ifneq (,$(wildcard $(ORG_DIR)))
  EL_OVERRIDES =
# This one no longer necessary since we install org-mode directly
# into $(PRE_INSTALL_DIR)
#   EL_OVERRIDES = org*
endif

# }}}

# {{{ ignore paths and files

# This will prevent any resulting .elc files from being compiled
# and consequently installed.
NO_COMPILE_EL_PATTERNS = 

ifneq (,$(YASNIPPET_DIR))
  NO_COMPILE_EL_PATTERNS += $(YASNIPPET_DIR)%
endif
ifneq (,$(COLOR_THEME_DIR))
  NO_COMPILE_EL_PATTERNS += fun/pastels-on-dark-theme.el
endif

# This will prevent matching .el files from being installed.
NO_INSTALL_PATTERNS =

# Pretend these don't exist at all.
IGNORE_PATHS = 					\
	$(MINOR_MODES)/msf-abbrev/mode-abbrevs 	\
	$(YASNIPPET_DIR)-*		\
	$(YASNIPPET_DIR)/snippets		\
	$(YASNIPPET_DIR)/extras  		\
	$(MAJOR_MODES)/monkey-2
IGNORE_FILES =		    		\
	loaddefs.el			\
	$(MAJOR_MODES)/sdf.el  		\
	$(MAJOR_MODES)/mediawiki.el

ifeq (,$(wildcard $(ORG_DIR)))
  IGNORE_FILES += $(MAJOR_MODES)/org-*.el $(UTILS)/as-gtd.el
endif

ifeq "$(findstring 21.,$(VERSION_NUMBER))" "21."
# org-annotation-helper.el needs url which isn't in emacs 21
# ditto org-irc.el which needs erc
  IGNORE_FILES += $(MAJOR_MODES)/org-annotation-helper.el \
		  $(ORG_DIR)/lisp/org-irc.el
endif

# }}}
# {{{ Directories to scan for autoload cookies

LOADDEFS_DIRS=	\
	$(UTILS)

# }}}
# {{{ global paths

EMACSLIB = $(HOME)/lib/emacs

GNUINSTALL_DIR = $(EMACSLIB)/GNU_Emacs
XINSTALL_DIR = $(EMACSLIB)/XEmacs

prefix   = $(HOME)/local
infodir = $(prefix)/share/info

# This is where some third-party stuff like epg gets installed,
# although any third-party packages whose Makefiles are flexible
# enough to get installed to $(POST_INSTALL_DIR) should probably
# be installed there for simplicity.
lispdir = $(prefix)/share/emacs/site-lisp

# }}}

TO_CLEAN = psgml nxml emacs-w3m pgg

ifneq (,$(wildcard $(ORG_DIR)))
  TO_CLEAN += org
endif
ifneq (,$(wildcard $(EPG_DIR)))
  TO_CLEAN += epg
endif
ifneq (,$(wildcard $(COLOR_THEME_DIR)))
  TO_CLEAN += color-theme
endif

# }}}

# {{{ Figure out which .els to compile ourselves.

# The list should comprise of everything we can find which we're not
# completely ignoring, but excluding stuff generated by third-party
# Makefiles.

# Horrible horrible horrible.  Prune 3rd party packages from imminent find(1).
PRUNE_DIRS = $(shell echo $(THIRD_PARTY_PKG_DIRS) $(IGNORE_PATHS) | perl -040lpe 's|(.+)|! -path "$$1/*" |g')
PRUNE_FILES = $(shell echo $(THIRD_PARTY_PKG_DIRS) $(IGNORE_FILES) | perl -040lpe 's|(.+)|! -path "$$1" |g')

# We exclude as-init.el here because it has to be compiled after everything else.
EL_INSTALLATION_CANDIDATES_cmd =   				        \
	find $(el_search_paths)				\
	        -follow					\
		-name \*.el 				\
	      $(PRUNE_DIRS)				\
	      $(PRUNE_FILES)				\
	      ! -name as-init.el			\
	      ! -path '*/attic/*'			\
	      ! -path '*/shimbun/*'
EL_INSTALLATION_CANDIDATES = $(shell $(EL_INSTALLATION_CANDIDATES_cmd)) 

# These are the .elcs we want to build ourselves
ELCs_TO_BE_COMPILED = $(addsuffix c,$(filter-out $(NO_COMPILE_EL_PATTERNS),$(EL_INSTALLATION_CANDIDATES)))

# }}}
# {{{ THIRD_PARTY_ELCs

# Do a separate search for elcs since we want to include ones which were
# built from vendor Makefiles.
# Note that the shell expansion is deferred until needed.
THIRD_PARTY_ELCs = $(shell \
	find $(THIRD_PARTY_PKG_DIRS) -follow -name \*.elc \
)
# We also need to know which vendor-provided .el files to install
# into the destination directory, so that find-library works.
THIRD_PARTY_ELs = $(shell \
	find $(THIRD_PARTY_PKG_DIRS) -follow -name \*.el | so \
)

# }}}

AS_INIT_EL    	    = init/common/as-init.el
AS_BINDINGS_EL	    = init/common/as-bindings.el
AS_PROGRESS_EL	    = init/common/as-progress.el
AS_REQUIRE_EL  	    = init/common/as-require.el
AS_INIT_ELC         = $(AS_INIT_EL)c
AS_BINDINGS_ELC     = $(AS_BINDINGS_EL)c
AS_PROGRESS_ELC     = $(AS_PROGRESS_EL)c
AS_REQUIRE_ELC 	    = $(AS_REQUIRE_EL)c

# {{{ Determine compilation variables and parameters

BATCH_EVAL=$(EMACS) -q --batch --no-site-file --eval

SYSTEM_TYPE=$(shell $(BATCH_EVAL) \
		'(message (format "%s" system-type))' 2>&1 | grep -v '^Loading ')

SITE_INSTALL_DIR=$(shell $(BATCH_EVAL) '(princ (car load-path))')

ifeq (, $(findstring XEmacs,$(version)))
  # GNU Emacs
  LOADPATH_OPTS=$(addprefix -L ,$(LIBDIRS))

  # Really ugly hack to add all subdirs of lispdir to the load-path.
  # This is required for instance so that org-crypt can compile against
  # ~/local/share/emacs/site-lisp/epg/
  LOADPATH_OPTS += \
	--eval "(let ((orig-dir default-directory)) 		\
		   (cd \"$(lispdir)\") 				\
		   (normal-top-level-add-subdirs-to-load-path) 	\
		   (cd orig-dir))"				\
	--eval "(normal-top-level-add-to-load-path '(\"$(lispdir)\"))"
#	--eval "(message (princ-list load-path))" \

  INSTALL_DIR=$(GNUINSTALL_DIR)/$(VERSION_NUMBER)/$(SYSTEM_TYPE)
else
  # X Emacs.  Blegh!
  LOADPATH_OPTS=$(addsuffix \" ,$(addprefix \",$(LIBDIRS)))
#  LOADPATH_OPTS=--eval "(setq load-path (append '($(LOADPATH_OPTS)) load-path))"
  INSTALL_DIR=$(XINSTALL_DIR)/$(VERSION_NUMBER)/$(SYSTEM_TYPE)
endif

PRE_INSTALL_DIR  = $(INSTALL_DIR)/pre
POST_INSTALL_DIR = $(INSTALL_DIR)/post

COMPILER=$(EMACS) --no-site-file
#COMPILER += --eval '(setq debug-on-error t)'
COMPILER_BATCH=-batch -f batch-byte-compile
COMPILER_OPTS=$(COMPILER_BATCH)

# }}}

# {{{ Phony targets

# Phony targets are bad except for top-level rules because if a rule A
# has a phony prerequisite B, that phony rule B will always get
# executed, even if B's prerequisites don't need to be, hence the
# parent rule will too.

.PHONY: all #$(THIRD_PARTY_PKG_TARGETS)

# }}}

all: .elcs install

# {{{ debugging targets

show-compiler:
	@echo 'COMPILER:          "$(COMPILER)"'
	@echo 'COMPILER_PRE_OPTS: "$(COMPILER_PRE_OPTS)"'
	@echo 'COMPILER_OPTS:     "$(COMPILER_OPTS)"'

list-libdirs:
	@echo '$(LIBDIRS)'

list-loadpath-opts:
	@echo '$(LOADPATH_OPTS)'

list-prune:
	@echo "$(PRUNE_DIRS)"
	@echo "$(PRUNE_FILES)"

list-el-installation-candidates-cmd:
	@echo "$(EL_INSTALLATION_CANDIDATES_cmd)"

list-el-installation-candidates:
	@for el in $(EL_INSTALLATION_CANDIDATES); do echo $$el; done

list-elcs-to-be-compiled:
	@for elc in $(ELCs_TO_BE_COMPILED); do echo $$elc; done

list-third-party-pkg-dirs:
	@for elc in $(THIRD_PARTY_PKG_DIRS); do echo $$elc; done

list-third-party-els:
	@for elc in $(THIRD_PARTY_ELs); do echo $$elc; done

list-third-party-elcs:
	@for elc in $(THIRD_PARTY_ELCs); do echo $$elc; done

list-install-files:
	@for file in $(INSTALL_FILES); do echo $$file; done

list-install-files-unfiltered:
	@for file in $(INSTALL_FILES_UNFILTERED); do echo $$file; done

# }}}
# {{{ high-level targets

# as-init.el has to be compiled after everything else.
.elcs: $(ELCs_TO_BE_COMPILED) $(THIRD_PARTY_PKG_TARGETS) $(AS_INIT_ELC)
	@touch $@

$(PRE_INSTALL_DIR) $(POST_INSTALL_DIR):
	@[ -d $@ ] || mkdir -p $@

.PHONY: install force-install
force-install: clean-installed install

.PHONY: clean-installed
clean-installed:
	@rm -f .installed

install: .installed

# N.B. Must install .el files as well as .elc files so that
# find-function-source-path doesn't need to be extended excessively.
# Note that THIRD_PARTY_ELCs already get installed by third party
# Makefiles into $(lispdir). It would be nice to install the
# THIRD_PARTY_ELs too, although to be soft we would have to install
# them also into $(lispdir) not $(POST_INSTALL_DIR), since e.g. color-theme
# does:
#
# (defcustom color-theme-libraries (directory-files 
#                                   (concat 
#                                    (file-name-directory (locate-library "color-theme"))
#                                    "/themes") t "^color-theme")
INSTALL_FILES_UNFILTERED = \
	$(EL_INSTALLATION_CANDIDATES) $(ELCs_TO_BE_COMPILED) \
	$(AS_INIT_ELC)
INSTALL_FILES = $(filter-out $(NO_INSTALL_PATTERNS),$(INSTALL_FILES_UNFILTERED))

ifneq (,$(EL_OVERRIDES))
ALL_OVERRIDES = \
	$(addsuffix .el,  $(EL_OVERRIDES)) \
	$(addsuffix .elc, $(EL_OVERRIDES))
endif

.PHONY: unlock-install-dirs lock-install-dirs
UNLOCK_INSTALL_DIRS = $(MAKE) -s unlock-install-dirs
LOCK_INSTALL_DIRS   = $(MAKE) -s lock-install-dirs
unlock-install-dirs: $(PRE_INSTALL_DIR) $(POST_INSTALL_DIR)
	@echo "Making files in $(PRE_INSTALL_DIR) and $(POST_INSTALL_DIR) read/write ..."
	@chmod -R u+w $(PRE_INSTALL_DIR) $(POST_INSTALL_DIR)
lock-install-dirs:
	@echo "Making files in $(PRE_INSTALL_DIR) and $(POST_INSTALL_DIR) read-only ..."
	@chmod -R a-w $(PRE_INSTALL_DIR) $(POST_INSTALL_DIR)

.installed: .elcs
	@$(UNLOCK_INSTALL_DIRS)
	@echo "Installing .el and .elc files in $(POST_INSTALL_DIR) ..."
	@cp -f $(INSTALL_FILES) $(POST_INSTALL_DIR)
	@cd $(POST_INSTALL_DIR) && \
	   if [ -n "$(ALL_OVERRIDES)" ]; then \
	     echo "Moving overrides from $(POST_INSTALL_DIR) to $(PRE_INSTALL_DIR)" && \
	     mv $(ALL_OVERRIDES) $(PRE_INSTALL_DIR) && \
	     for f in $(ALL_OVERRIDES); do \
	       if [ -e "$$f" ]; then \
	         echo "$$f still in $(POST_INSTALL_DIR) - WHY??"; \
	         exit 1; \
	       fi; \
	     done; \
	   fi
	@$(LOCK_INSTALL_DIRS)
	@touch $@

# Some shitty Solaris makes have broken $(wildcard foo/*.bar)
.PHONY: clean
clean: uninstall $(addprefix clean-, $(TO_CLEAN))
	@-find $(EMACSLIB) -follow -name \*.elc -print | xargs -r rm -f
	rm -f .*-made
	for dir in $(THIRD_PARTY_PKG_DIRS); do \
		( cd $$dir && make clean )     \
	done

.PHONY: uninstall
uninstall:
	-find $(PRE_INSTALL_DIR) $(POST_INSTALL_DIR) -name \*.elc -print | \
		xargs -r rm -f

# }}}
# {{{ Autogenerate loaddefs

# Where to put as-loaddefs.el?  We need it for both compile- and
# run-time, but we don't want to pollute the compile-time load-path
# with POST_INSTALL_DIR, so we put it in a dedicated subdirectory:
LOADDEFS_DIR=$(POST_INSTALL_DIR)/loaddefs
LOADDEFS=$(LOADDEFS_DIR)/as-loaddefs.el
#LOADDEFS=$(POST_INSTALL_DIR:$(EMACSLIB)/%=%)/as-loaddefs.el

show-loaddefs:
	@echo '$(LOADDEFS)'
LOADDEFS_DEPS_CANDIDATES = $(addsuffix /*.el,$(LOADDEFS_DIRS))
LOADDEFS_DEPS = $(shell grep -l '^;;;\#\#\#autoload' $(LOADDEFS_DEPS_CANDIDATES))
show-loaddefs-deps:
	@echo $(LOADDEFS_DEPS)

# emacs 21 uses update-autoloads-from-directories
# emacs 22 uses update-directory-autoloads
LOADDEFS_DIRS_LISP=$(addsuffix ",$(addprefix "$(EMACSLIB)/,$(LOADDEFS_DIRS)))
define loaddefs_lisp
(progn \
    (setq generated-autoload-file "$(LOADDEFS)") \
    (if (>= emacs-major-version 22) \
        (update-directory-autoloads $(LOADDEFS_DIRS_LISP)) \
        (update-autoloads-from-directories $(LOADDEFS_DIRS_LISP))))
endef

.PHONY: loaddefs
loaddefs: $(LOADDEFS)

$(LOADDEFS): $(LOADDEFS_DEPS)
	@echo "### Generating $@"
	@$(UNLOCK_INSTALL_DIRS)
	@mkdir -p "$(LOADDEFS_DIR)"
# update-directory-autoloads requires non-empty file to update.
# It also sometimes fails to recognise that the source files have
# relevant changes, so we truncate it every time.
	@echo " " > "$(LOADDEFS)"
	$(BATCH_EVAL) '$(loaddefs_lisp)'
	@$(LOCK_INSTALL_DIRS)

# }}}
# {{{ General pattern-based rules for compiling .el to .elc

# hack to ensure that $(lispdir) exists, but does not force remake
# of targets which depend on it, when its timestamp is updated.
.lispdir:
	@mkdir -p $(lispdir) && touch $@

%.elc: %.el .lispdir
	@if [ -n "$(LIBDIRS)" ]; then \
	  echo "### Compiling $< with libs: $(LIBDIRS) ..."; \
	else \
	  echo "### Compiling $< ..."; \
	fi
	@$(COMPILER) $(LOADPATH_OPTS) $(COMPILER_PRE_OPTS) $(COMPILER_OPTS) $<

%.elc.verbose: %.el .lispdir
	@if [ -n "$(LIBDIRS)" ]; then \
	  echo "### Compiling $< with libs: $(LIBDIRS) ..."; \
	else \
	  echo "### Compiling $< ..."; \
	fi
	$(COMPILER) $(LOADPATH_OPTS) $(COMPILER_PRE_OPTS) $(COMPILER_OPTS) $(<:.verbose=)

# The idea behind this one is to launch an emacs in which a manual
# byte-compile of the .el can be debugged, but it doesn't work yet.
%.elc.debug: COMPILER_BATCH='-q -l bytecomp'
%.elc.debug: %.elc
	ln -sf $< $@
# 	rm -f $(@:.debug=)
# 	$(MAKE) $(@:.debug=) COMPILER_BATCH='-q -l bytecomp'

# }}}
# {{{ Special rules for my init files

INIT_COMMON_LIBDIRS = 		\
	init/common		\
	$(MAJOR_MODES)		\
	$(MAJOR_MODES)/mmm 	\
	$(ORG_DIR)/lisp		\
	$(MINOR_MODES)		\
	$(UTILS)		\
	fun

init/common/as-%.elc: LIBDIRS += $(INIT_COMMON_LIBDIRS)

$(AS_BINDINGS_ELC): $(AS_PROGRESS_ELC) .org-installed
$(AS_INIT_ELC): $(AS_PROGRESS_ELC) $(AS_REQUIRE_ELC) $(AS_BINDINGS_ELC)
$(AS_INIT_ELC): $(UTILS)/smooth-scrolling.elc
$(AS_INIT_ELC): $(LOADDEFS)
$(AS_INIT_ELC): LIBDIRS += $(LOADDEFS_DIR) $(lispdir) $(CUCUMBER_DIR) $(YASNIPPET_DIR)
#$(AS_INIT_ELC): COMPILER_PRE_OPTS = --eval '(load-file "$(LOADDEFS)")'

# }}}
# {{{ Special rules for utils files

# as-gtd needs $(ORG_DIR)/contrib/lisp/org-mairix.el
$(UTILS)/as-gtd.elc $(UTILS)/as-mairix.elc: LIBDIRS += $(UTILS) $(ORG_DIR)/contrib/lisp
$(UTILS)/as-gtd.elc $(UTILS)/as-mairix.elc: .org-installed

init/common/as-%.elc: LIBDIRS += $(INIT_COMMON_LIBDIRS)

# }}}
# {{{ org-mode

$(MAJOR_MODES)/org-action-verbs.elc: LIBDIRS += $(ORG_DIR)/lisp

.PHONY: org
org: .org-installed
ifeq (,$(wildcard $(ORG_DIR)))
clean-org:
	@echo "Won't clean non-existent $(ORG_DIR)"
.org-installed:
	@echo "Won't install from non-existent $(ORG_DIR)"
else
clean-org:
	rm -f .org-installed
	$(MAKE) -C $(ORG_DIR) clean
.org-installed: $(wildcard $(ORG_DIR)/lisp/*.el) .epg-installed
	@$(UNLOCK_INSTALL_DIRS)
#	EMACS="$(EMACS) -L $(lispdir)/epg"
	$(MAKE) -C $(ORG_DIR) install-lisp \
		prefix=$(prefix) \
		lispdir=$(PRE_INSTALL_DIR)
	cp $(ORG_DIR)/contrib/lisp/*.el $(PRE_INSTALL_DIR)
	@$(LOCK_INSTALL_DIRS)
	-$(MAKE) -C $(ORG_DIR) install-info \
		prefix=$(prefix) \
		infodir=$(infodir)
	touch $@
endif

# }}}
# {{{ mmm-mode

$(MAJOR_MODES)/mmm/%.elc: $(MAJOR_MODES)/mmm/%.el

$(MAJOR_MODES)/mmm/%.elc: LIBDIRS += $(MAJOR_MODES)/mmm

# }}}
# {{{ remember-mode

#$(MAJOR_MODES)/remember/%.elc: $(MAJOR_MODES)/remember/%.el
#$(MAJOR_MODES)/remember/%.elc: LIBDIRS += $(MAJOR_MODES)/remember

REMEMBER_DISABLE=$(addprefix remember-,bbdb bibl blosxom emacs-wiki-journal planner experimental)

remember: .remember-installed
clean-remember:
	rm -f .remember-made .remember-installed
	$(MAKE) -C $(REMEMBER_DIR) clean
.remember-made: $(wildcard $(REMEMBER_DIR)/*.el) $(REMEMBER_DIR)/Makefile.defs
	@( \
	  cd $(REMEMBER_DIR); \
	  echo "Disabling $(REMEMBER_DISABLE)"; \
	  for d in $(REMEMBER_DISABLE); do \
	    el=$$d.el; \
	    if [ -e "$$el" ]; then \
	      if mv "$$el" "$$el.disabled"; then \
	        echo "mv $$el $$el.disabled"; \
	      else \
	        echo "FAILED: mv $$el $$el.disabled"; \
		exit 1; \
	      fi; \
	    else \
	      echo "$$el not there"; \
	    fi; \
	  done; \
	)
	$(MAKE) -C $(REMEMBER_DIR) all \
		EMACS=$(EMACS) PREFIX=$(prefix) INFODIR=$(infodir)
	touch $@

.remember-installed: .remember-made
	@$(UNLOCK_INSTALL_DIRS)
	cd $(REMEMBER_DIR) && \
	  $(MAKE) install ELISPDIR=$(lispdir) INFODIR=$(infodir)
	@$(LOCK_INSTALL_DIRS)
	touch $@

# }}}
# {{{ psgml-mode

psgml: .psgml-made
clean-psgml:
	rm -f .psgml-made
# psgml Makefile is missing a 'clean' target
	rm -f $(MAJOR_MODES)/psgml/*.elc
.psgml-made:
	$(MAKE) -C $(MAJOR_MODES)/psgml
	touch $@

# }}}
# {{{ nxml-mode

nxml: .nxml-mode-20041004-made
clean-nxml:
	rm -f .nxml-mode-20041004-made
	$(MAKE) -C $(MAJOR_MODES)/nxml-mode-20041004 clean
.nxml-mode-20041004-made: $(POST_INSTALL_DIR)
	$(MAKE) -C $(MAJOR_MODES)/nxml-mode-20041004
	cp rng-auto.el $(POST_INSTALL_DIR)
	touch $@

# }}}
# {{{ emacs-w3m-mode

emacs-w3m: .emacs-w3m-made
clean-emacs-w3m:
	rm -f .emacs-w3m-made
	$(MAKE) -C $(MAJOR_MODES)/emacs-w3m-1.4.4 clean
.emacs-w3m-made:
	@$(UNLOCK_INSTALL_DIRS)
	( 					\
	  cd $(MAJOR_MODES)/emacs-w3m-1.4.4    && 	\
	  ./configure --prefix=$(prefix)	\
		      --infodir=$(infodir) && 	\
	  make				    && 	\
	  $(MAKE) install			    && 	\
	  cp w3m-load.el $(POST_INSTALL_DIR) 	\
	)
	@$(LOCK_INSTALL_DIRS)
	touch $@

# }}}
# {{{ pgg-mode

pgg: .pgg-made
clean-pgg:
	rm -f .pgg-made
	$(MAKE) -C $(MAJOR_MODES)/pgg clean
$(MAJOR_MODES)/pgg/%.elc: LIBDIRS += $(MAJOR_MODES)/pgg
.pgg-made: $(MAJOR_MODES)/pgg/pgg.elc
	@-cp $(MAJOR_MODES)/pgg/pgg.{el,elc} $(POST_INSTALL_DIR) && touch $@

# }}}
# {{{ epg-mode

epg: .epg-installed
ifeq (,$(wildcard $(EPG_DIR)))
clean-epg:
	@echo "Won't clean non-existent $(EPG_DIR)"
.epg-installed:
	@echo "Won't install from non-existent $(EPG_DIR)"
else
clean-epg:
	rm -f .epg-installed
	-$(MAKE) -C $(EPG_DIR) clean
.epg-installed: $(EPG_DIR)/epg.el
	@$(UNLOCK_INSTALL_DIRS)
	@-( cd $(EPG_DIR) && \
	  ./configure --prefix=$(prefix) \
	  	      --infodir=$(infodir) && \
	  $(MAKE) install \
	) && \
	$(LOCK_INSTALL_DIRS) && \
	echo "### epg installed" && \
	touch $@
endif

# }}}
# {{{ color-theme

.PHONY: color-theme
color-theme: .color-theme-installed
ifeq (,$(wildcard $(COLOR_THEME_DIR)))
clean-color-theme:
	@echo "Won't clean non-existent $(COLOR_THEME_DIR)"
.color-theme-installed:
	@echo "Won't install from non-existent $(COLOR_THEME_DIR)"
else
clean-color-theme:
	rm -rf .color-theme-installed $(lispdir)/color-theme* $(lispdir)/themes
	@$(UNLOCK_INSTALL_DIRS)
	rm -f $(POST_INSTALL_DIR)/color-theme*
	@$(LOCK_INSTALL_DIRS)
	$(MAKE) -C $(COLOR_THEME_DIR) clean

# FIXME: handle case where color-theme not available
fun/pastels-on-dark-theme.el: .color-theme-installed

.color-theme-installed: $(wildcard $(COLOR_THEME_DIR)/*.el)
	$(MAKE) -C $(COLOR_THEME_DIR) autoloads install-bin \
		PREFIX=$(prefix) \
		ELISPDIR=$(lispdir) \
		INFODIR=$(infodir)
	touch $@
endif

# }}}


