el_search_paths = 			\
	init/common 			\
	$(wildcard major-modes/*.el) 	\
	major-modes/mmm 		\
	major-modes/org-3.15 		\
	major-modes/pcl-cvs 		\
	major-modes/remember 		\
	minor-modes 			\
	utils 				\
	fun

# These ones have their own Makefiles
THIRD_PARTY_PKGS = 		\
	nxml-mode-20041004 	\
	emacs-wiki 		\
	psgml 			\
	emacs-w3m 		\
	muse 			\
	planner 		\
	xtla

# Don't automatically compile *.el in these directories:
THIRD_PARTY_PKG_DIRS = $(addprefix major-modes/, 	\
	nxml-mode-20041004 				\
	emacs-wiki 					\
	psgml 						\
	emacs-w3m-1.4.4 				\
	muse 						\
	planner 					\
	xtla 						\
	)

# Pretend these don't exist at all.
IGNORE_PATHS = 				\
	major-modes/xtla-main 		\
	major-modes/planner--main--1.0 	\
	major-modes/monkey-2
IGNORE_FILES =		    \
	major-modes/sdf.el

# Phony targets are bad except for top-level rules because if a rule A
# has a phony prerequisite B, that phony rule B will always get
# executed, even if B's prerequisites don't need to be, hence the
# parent rule will too.

# Set up targets for dealing with third-party Makefiles
THIRD_PARTY_TARGETS = $(addprefix .,$(THIRD_PARTY_PKGS))
THIRD_PARTY_TARGETS := $(addsuffix -made,$(THIRD_PARTY_TARGETS))

EMACSLIB = $(HOME)/lib/emacs

# Add these loadpaths during compilation only.
loadpaths = $(EMACSLIB)/minor-modes 			\
            $(EMACSLIB)/major-modes/mmm 		\
            $(EMACSLIB)/major-modes/tdtd 		\
            $(EMACSLIB)/major-modes/pcl-cvs 		\
            $(EMACSLIB)/major-modes/monkey-2 		\
            $(EMACSLIB)/major-modes/nxml-mode-20041004	\
            $(EMACSLIB)/major-modes/xtla/lisp           \
            $(EMACSLIB)/major-modes/etask-0.3.91a       \
            $(EMACSLIB)/major-modes/emacs-w3m-1.4.4     \
            $(EMACSLIB)/major-modes/planner     	\
            $(EMACSLIB)/major-modes/emacs-wiki	        \
            $(EMACSLIB)/major-modes/muse/lisp	        \
            $(EMACSLIB)/major-modes/remember  	        \
            $(EMACSLIB)/major-modes/pgg  	        \
            $(EMACSLIB)/major-modes			\
            $(EMACSLIB)/utils/tree-widget-2.0

gnuinstall_dir = $(EMACSLIB)/GNU_Emacs
xinstall_dir = $(EMACSLIB)/XEmacs

# Figure out which .els to compile ourselves.  The list should comprise of
# everything we can find which we're not completely ignoring, but excluding
# stuff generated by third-party Makefiles.

# Horrible horrible horrible.  Prune 3rd party packages from imminent find(1).
prune_dirs = $(shell echo $(THIRD_PARTY_PKG_DIRS) $(IGNORE_PATHS) | perl -040lpe 's|(.+)|! -path "$$1/*" |g')
prune_files = $(shell echo $(THIRD_PARTY_PKG_DIRS) $(IGNORE_FILES) | perl -040lpe 's|(.+)|! -path "$$1" |g')

ELs_TO_COMPILE_cmd =   				        \
	find $(el_search_paths)				\
	        -follow					\
		-name \*.el 				\
	      $(prune_dirs)				\
	      $(prune_files)				\
	      ! -name remember-bbdb.el 			\
	      ! -name remember-bibl.el 			\
	      ! -name remember-blosxom.el 		\
	      ! -name remember-emacs-wiki-journal.el 	\
	      ! -path '*/attic/*'			\
	      ! -path '*/shimbun/*'
ELs_TO_COMPILE = $(shell $(ELs_TO_COMPILE_cmd)) 

# These are the .elcs we want to build ourselves
ELCs_TO_COMPILE = $(addsuffix c,$(ELs_TO_COMPILE))

# Do a separate search for elcs since we want to include ones which were
# built from vendor Makefiles.
THIRD_PARTY_ELCs = $(shell \
	find $(THIRD_PARTY_PKG_DIRS) -name \*.elc \
	  ! -path 'major-modes/emacs-w3m-1.4.4/*' \
)

ifndef EMACS
  EMACS=emacs
endif

version=$(shell $(EMACS) --version)
version_number=$(shell echo "$(version)" | \
                   perl -ne '/^\s*(GNU |X)Emacs (\d+\.\d+)/ && print "$$2"')
system_type=$(shell $(EMACS) -q --batch --eval '(message (format "%s" system-type))' 2>&1 | grep -v '^Loading ')

site_install_dir=$(shell $(EMACS) -q --batch --eval '(princ (car load-path))')

ifeq (, $(findstring XEmacs,$(version)))
  EMACS_LOADPATHS=$(EMACS) $(addprefix -L ,$(loadpaths))
  install_dir=$(gnuinstall_dir)/$(version_number)/$(system_type)
else
  # blegh!
  LOADPATHS=$(addsuffix \" ,$(addprefix \",$(loadpaths)))
  EMACS_LOADPATHS=$(EMACS) -eval "(setq load-path (append '($(LOADPATHS)) load-path))"
  install_dir=$(xinstall_dir)/$(version_number)/$(system_type)
endif

COMPILER=$(EMACS_LOADPATHS) -batch -f batch-byte-compile

.PHONY: all elcs install clean uninstall

all: elcs install

list-loadpaths:
	@echo "$(loadpaths)"

list-prune:
	@echo "$(prune)"

list-els-to-compile-cmd:
	@echo "$(ELs_TO_COMPILE_cmd)"

list-els-to-compile:
	@for el in $(ELs_TO_COMPILE); do echo $$el; done

list-third-party-elcs:
	@for elc in $(THIRD_PARTY_ELCs); do echo $$elc; done

.elcs: $(ELCs_TO_COMPILE) $(THIRD_PARTY_TARGETS) Makefile
	@touch $@

$(install_dir):
	@[ -d $(install_dir) ] || mkdir -p $(install_dir)

install: .installed

.installed: Makefile .elcs $(install_dir) #uninstall
	@echo "Installing all .elcs in $(install_dir)"
	@for elc in $(ELCs_TO_COMPILE) $(THIRD_PARTY_ELCs); do 	\
	  cp $$elc $(install_dir); 				\
	done
	@touch $@

%.elc: %.el
	@echo Compiling $< with $(EMACS) ...
	@$(COMPILER) $<

# Some shitty Solaris makes have broken $(wildcard foo/*.bar)
clean: uninstall
	@-find $(EMACSLIB) -name \*.elc -print | xargs rm -f
	rm -f .*-made
	rm -f major-modes/nxml-mode-20041004/stamp-byte-compile
	for dir in $(THIRD_PARTY_PKG_DIRS); do \
		( cd $$dir && make clean )      \
	done

uninstall:
	-find $(install_dir) -name \*.elc -print | xargs rm -f

psgml: .psgml-made
.psgml-made:
	( cd major-modes/psgml && $(MAKE) ) && \
	touch $@

nxml: .nxml-mode-20041004-made
.nxml-mode-20041004-made: $(install_dir)
	( 					\
	  cd major-modes/nxml-mode-20041004 && 	\
	  $(MAKE) && 				\
	  cp rng-auto.el $(install_dir) 	\
	) && 					\
	touch $@

wiki: .emacs-wiki-made
.emacs-wiki-made: $(wildcard major-modes/emacs-wiki/*.el) major-modes/emacs-wiki/Makefile.defs
	( 								\
	  cd major-modes/emacs-wiki && 					\
	  perl -pi -e 's/^(EMACS\s*=\s*).*/$$1$(EMACS)/; 		\
                       s!^(PREFIX\s*=\s*).*!$${1}$(HOME)/local!' 	\
	  	Makefile.defs && 					\
	  make && 							\
	  make doc && 							\
	  make install 							\
	) && 								\
	touch $@

muse: .muse-made
.muse-made: $(wildcard major-modes/muse/*.el) major-modes/muse/Makefile.defs Makefile
	( 								\
	  cd major-modes/muse && 					\
	  perl -pi -e 's/^(EMACS\s*=\s*).*/$$1$(EMACS)/; 		\
                       s!^(PREFIX\s*=\s*).*!$${1}$(HOME)/local!' 	\
	  	Makefile.defs && 					\
	  make lisp && 							\
	  make install-bin 						\
	) && 								\
	touch $@

planner: .planner-made
.planner-made: $(wildcard major-modes/planner/*.el) major-modes/planner/Makefile.defs .muse-made .xtla-made
	( 								\
	  cd major-modes/planner && 					\
	  perl -pi -e 's!^(EMACS\s*=\s*).*!$$1$(EMACS_LOADPATHS)!;	\
                       s!^(PREFIX\s*=\s*).*!$${1}$(HOME)/local!' 	\
	  	Makefile.defs && 					\
	  make lisp && 							\
	  make install							\
	) && 								\
	touch $@

w3m: .emacs-w3m-made
.emacs-w3m-made:
	( 					\
	  cd major-modes/emacs-w3m-1.4.4     && \
	  ./configure --prefix=$(HOME)/local && \
	  make				     && \
	  make install			     && \
	  cp w3m-load.el $(install_dir) 	\
	) && 					\
	touch $@

pgg: pgg-made
.pgg-made: major-modes/pgg/pgg.elc
	@touch $@

.xtla-configured: major-modes/xtla/configure Makefile
	-( 								\
	  cd major-modes/xtla && 					\
	  ./configure 							\
	    --prefix=$(HOME)/local 					\
	    --with-other-dirs=$(HOME)/lib/emacs/utils/tree-widget-2.0 	\
	    --with-arch=baz 						\
	) && 								\
	touch $@

xtla: .xtla-made
.xtla-made: $(wildcard major-modes/xtla/*.el) $(wildcard major-modes/xtla/*/*.el) .xtla-configured Makefile
	-( 				\
	  cd major-modes/xtla && 	\
	  make && 			\
	  make install-pkg 		\
	) && 				\
	touch $@

major-modes/xtla/configure: major-modes/xtla/configure.ac
	-cd major-modes/xtla && autoconf

major-modes/remember/remember-experimental.elc: .planner-made
